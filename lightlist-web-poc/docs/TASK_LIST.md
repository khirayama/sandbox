# タスクリスト機能ドキュメント

## 概要

LightList はタスクリスト管理機能を提供しており、複数のタスクリストを作成・管理できます。各タスクリストは個別のタスクを含み、ユーザーが効率的に作業を管理できるように設計されています。

## タスクリスト一覧ページ

**ページ:** `src/pages/app.tsx`

### 概要

タスクリスト一覧ページは、ユーザーのすべてのタスクリストをグリッド表示し、新規作成機能を提供します。

### 主要機能

#### 1. タスクリスト一覧表示

**仕様:**

- グリッドレイアウトで複数のタスクリストを表示
  - レスポンシブ対応：1列（モバイル）→ 2列（タブレット）→ 3列（デスクトップ）
- 各リストカード上に以下の情報を表示：
  - リスト名（切り詰め表示対応）
  - タスク数（"X tasks" フォーマット）
  - 背景色の視覚的インジケータ（カードの上部に4px の色付きボーダー）
- リストカードはホバー時にスケールとシャドウが増加（視覚的フィードバック）

**エラーハンドリング:**

- 認証されていないユーザーはリダイレクト処理により、`/` へ移動
- リスト読み込み中の状態をローディング表示で表現

#### 2. 空の状態表示

**表示条件:**

タスクリストが存在しない場合、以下の空の状態画面を表示：

- "タスクリストがありません" メッセージ
- 新規作成ボタンへ導く UI

#### 3. 新規作成機能

**ページレイアウト:**

- 一覧下部に「新規作成」ボタンを配置
- 空の状態でも「新規作成」ボタンを表示可能

**モーダルフォーム:**

1. ボタンをクリックするとモーダルフォームが表示される
2. リスト名入力フィールドと確認ボタンを提供
3. 以下の操作をサポート：
   - **テキスト入力:** リスト名の入力
   - **Enter キー:** フォーム送信のショートカット（`creatingList` が false の場合）
   - **キャンセルボタン:** モーダルを閉じて入力をクリア
   - **作成ボタ:** 新規リストを作成

**処理フロー:**

```
1. ユーザーが「新規作成」ボタンをクリック
   ↓
2. モーダルフォーム表示
   ↓
3. リスト名を入力（検証：空白は不可）
   ↓
4. 「作成」ボタンをクリック
   ↓
5. `createTaskList(name)` 関数を呼び出し
   ↓
6. Firestore にリストを作成
   ↓
7. ストアを更新（自動的に画面に反映）
   ↓
8. モーダルを閉じて、入力をリセット
```

**エラーハンドリング:**

- 作成中にエラーが発生した場合、エラーメッセージを表示
- ユーザーは同じモーダル内で再度試行可能

#### 4. リスト詳細ページへのナビゲーション

**ユーザー操作:**

リストカードをクリックすると、リスト詳細ページ（`/list/{taskListId}`）へナビゲート

#### 5. タスクリストの並び替え（ドラッグ&ドロップ）

**機能:**

各タスクリストカードの左側にあるドラッグハンドル（≡アイコン）をドラッグして、リストの順序を変更できます。

**ユーザー操作:**

1. ドラッグハンドルをマウスで押下（ポインタ感度: 8px）
2. マウスを上下・左右に移動してリストの順序を変更
3. マウスボタンを放すと新しい順序が保存される

**キーボード操作:**

- `arrow-up/down` キーでもドラッグハンドルをフォーカス後に順序変更が可能（アクセシビリティ対応）

**処理フロー:**

```
1. ユーザーがドラッグハンドルをドラッグ開始
   ↓
2. ドラッグ中はカードが半透明表示
   ↓
3. ドラッグ終了時にドラッグされたリストと対象リストを特定
   ↓
4. 浮動小数 order を使用して新しい order 値を計算
   ↓
5. `updateTaskListOrder(draggedTaskListId, targetTaskListId)` を呼び出し
   ↓
6. 必要に応じて reindex を実行
   ↓
7. Firestore を更新（トランザクション使用）
   ↓
8. ストアが更新され、自動的に画面に反映
```

**視覚的フィードバック:**

- ドラッグハンドルはホバー時に色が濃くなる（`hover:text-gray-600`）
- ドラッグ中のカードは半透明表示（`opacity-50`）
- ドラッグハンドルは `cursor-grab` から `cursor-grabbing` に変更

**技術詳細:**

- ライブラリ: `@dnd-kit/core` と `@dnd-kit/sortable` を使用
- ポインタセンサーとキーボードセンサーの両方に対応
- 最も近い衝突検出アルゴリズムを使用（`closestCenter`）
- グリッドレイアウトに対応

## 状態管理

### ページレベルの状態

```typescript
const [showCreateListForm, setShowCreateListForm] = useState(false);
const [createListInput, setCreateListInput] = useState("");
const [creatingList, setCreatingList] = useState(false);
```

### アプリケーション状態（Store）

タスクリストデータは `appStore` から取得されます：

```typescript
const state: AppState = {
  user: User | null,
  settings: Settings | null,
  taskLists: TaskList[]  // 順序付きリスト
};
```

## API インターフェース

### createTaskList(name: string, background?: string): Promise<string>

新しいタスクリストを作成します。

**パラメータ:**

- `name`: タスクリスト名（必須）
- `background`: 背景色（オプション、デフォルト: `"#ffffff"`）

**戻り値:**

- 作成されたタスクリスト ID

**動作:**

1. ローカルストアを楽観的に更新
2. Firestore に新規リストドキュメントを作成
3. `taskListOrder` に新規リストの順序情報を追加
4. `updatedAt` タイムスタンプを自動設定
5. ストアの変更をリスナーに通知

**例外:**

- Firebase Firestore のエラーをスロー
- ユーザーログイン状態を確認し、ログインしていない場合はエラーをスロー

### updateTaskListOrder(draggedTaskListId: string, targetTaskListId: string): Promise<void>

タスクリストの順序を更新します（ドラッグ&ドロップ時）。

**パラメータ:**

- `draggedTaskListId`: ドラッグされたタスクリスト ID
- `targetTaskListId`: ドロップ先のタスクリスト ID（この前に挿入）

**例:**

```typescript
await updateTaskListOrder("list-id-1", "list-id-3");
// list-id-1 が list-id-3 の前に移動
```

**動作:**

1. 浮動小数 order を使用して新しい order 値を計算
   - ドラッグされたリストと対象リストの order の中間値 (例: (1.0 + 2.0) / 2 = 1.5)
   - 先頭または末尾への移動に対応
2. 小数が枯渇している場合は自動的に reindex を実行
3. ローカルストアを楽観的に更新
4. トランザクションを使用して Firestore の `taskListOrder` ドキュメントを更新
5. `updatedAt` タイムスタンプを自動設定
6. ストアの変更をリスナーに通知

**技術仕様：**

- **order フィールド:** 浮動小数（整数ではなく 1.5, 2.25 など）
- **reindex 判定:** MIN_ORDER_GAP (0.0001) より小さい order 間隔の場合に自動実行
- **トランザクション処理:** 並行更新時の安全性を確保

**例外:**

- Firebase Firestore のエラーをスロー
- 指定されたタスクリストが見つからない場合はエラーをスロー

## 翻訳キー

タスクリスト機能の UI テキストは i18next を使用して多言語対応されています。

**メッセージキー:**

```
app:
  title: タスクページのタイトル（"タスク" / "Tasks"）
  emptyState: タスクリストがない状態のメッセージ
  createNew: 新規作成ボタンのテキスト
  createTaskList: モーダルタイトル
  taskListName: リスト名入力フィールドのラベル
  taskListNamePlaceholder: 入力フィールドのプレースホルダー
  create: 作成ボタンのテキスト
  creating: 作成中の状態表示テキスト
  cancel: キャンセルボタンのテキスト
  error: エラーメッセージ（汎用）
  moveUp: 上へ移動ボタンのテキスト
  moveDown: 下へ移動ボタンのテキスト
```

詳細は `locales/ja.json` および `locales/en.json` を参照してください。

## デザイン仕様

### タスクリストカード

- **背景:** 白色（`bg-white`）
- **シャドウ:** 標準シャドウ（`shadow`）、ホバー時に強調（`hover:shadow-lg`）
- **コーナー:** 丸角（`rounded-lg`）
- **上部ボーダー:** 4px の色付きボーダー（背景色を視覚化）
- **内部構造:**
  - ドラッグハンドル、リスト情報が横方向に配置
  - パディング中程度（`p-4`）
  - ドラッグハンドルは flex-shrink-0 で幅固定
- **ホバー効果:**
  - シャドウ増加（`shadow-lg`）
  - スムーズなトランジション（`transition-all`）
- **ドラッグ中:**
  - 半透明表示（`opacity-50`）

### ドラッグハンドル

- **アイコン:** ≡ アイコン（6ドット）
- **色:** グレー（`text-gray-400`）
- **ホバー色:** より濃いグレー（`hover:text-gray-600`）
- **カーソル:** `cursor-grab` / `cursor-grabbing`

### モーダルフォーム

- **背景オーバーレイ:** 半透明黒（`bg-black bg-opacity-50`）
- **フォーム背景:** 白色（`bg-white`）
- **最大幅:** 中程度（`max-w-sm`）
- **パディング:** 中程度（`p-6`）
- **入力フィールド:** ボーダースタイル、フォーカス時はインディゴリング

### 色スキーム

- **プライマリアクション:** インディゴ（`bg-indigo-600`）
- **キャンセル:** グレー（`bg-gray-300`）
- **エラー:** 赤（`bg-red-50` / `text-red-700`）
- **ホバー:** より濃い色へ遷移

## 浮動小数 order システム

### 概要

タスクとタスクリストの並び替え時に、整数ではなく浮動小数を使用した `order` フィールドを管理しています。これにより、並び替え時の更新件数を最小化し、並行更新時の競合を大幅に削減しています。

### 設計の利点

1. **最小更新:** 並び替え時にドラッグされたアイテム1件のみ更新
   - 従来方式: 整数 order で全アイテムを再計算（複数更新）
   - 新方式: 浮動小数で対象アイテムのみ計算（1件更新）

2. **並行更新への耐性:** 複数ユーザーが同時に並び替えても競合しにくい
   - 中間値計算により、order の衝突が発生しない設計

3. **トランザクション対応:** Firebase トランザクションを使用した安全な更新

### 実装詳細

**ファイル:** `src/lib/utils/order.ts`

**主要関数:**

- `calculateOrderForInsert(tasks, insertPosition)`: 新規アイテム追加時の order を計算
- `calculateDragDropOrder(tasks, draggedId, targetId)`: ドラッグ&ドロップ時の order を計算
- `reindexOrders(tasks)`: order を再割り当て（小数枯渇時）
- `needsReindex(prevOrder, nextOrder)`: reindex 判定
- `shouldReindex(orders)`: 複数 order に対する reindex 判定

**定数:**

- `MIN_ORDER_GAP = 0.0001`: order 間隔の閾値（これ未満で reindex トリガー）

### reindex（再割り当て）処理

小数が密集して間隔が `MIN_ORDER_GAP` を下回った場合、自動的に以下の処理を実行：

1. 既存アイテムの order を昇順でソート
2. 新しい order を `1.0, 2.0, 3.0, ...` に再割り当て
3. すべての order を1度のトランザクションで更新

**自動トリガー:**

- `addTask` 時：新規タスク追加前に判定
- `updateTasksOrder` 時：並び替え前に判定
- `updateTaskListOrder` 時：並び替え前に判定

### 実装上の注意点

1. **float 精度:** JavaScript の float 精度（0.0001以上）を前提
2. **トランザクション:** Firestore の runTransaction を使用
3. **ローカルステート:** 楽観的更新 + リモート同期

### 互換性

- 既存の整数 order データはそのまま使用可能
- 新規作成時は自動的に浮動小数に変換

## パフォーマンス考慮事項

### 最適化

1. **グリッドレスポンシブ:** Tailwind CSS ブレークポイントで効率的に実装
2. **リスト表示:** React の `map` で効率的にレンダリング
3. **状態更新:** 必要な状態変更のみトリガー
4. **order 更新:** 浮動小数により、並び替え時の更新件数を最小化

### 注意点

- リストが大量の場合、仮想スクロール導入を検討
- タスク数が多い場合、ページングを検討
- 非常に多くの並び替え操作が発生する場合、reindex 実行をモニタリング

## トラブルシューティング

### タスクリストが表示されない

1. ユーザーがログインしているか確認
2. Firebase の認証状態が正しいか確認
3. Firestore のデータ構造が正しいか確認
4. ブラウザの開発者ツールでコンソールエラーを確認

### 新規作成ができない

1. インターネット接続を確認
2. Firebase のセキュリティルールを確認（書き込み権限があるか）
3. リスト名が空でないか確認
4. ローディング状態が正しくリセットされているか確認

### モーダルが閉じない

1. キャンセルボタンをクリック
2. ブラウザを刷新してセッションをリセット

## タスク詳細ページ

**ページ:** `src/pages/tasklists/[id].tsx`

### 概要

タスク詳細ページは、特定のタスクリスト内のすべてのタスクを表示・管理します。タスクの作成、編集、削除、完了状態の切り替え、および並び替え機能を提供します。

### 主要機能

#### 1. タスク一覧表示

**仕様:**

- タスクリスト内のすべてのタスクをリスト形式で表示
- 各タスクアイテムは以下の情報を含む：
  - ドラッグハンドル（≡アイコン）：タスクの並び替えに使用
  - チェックボックス：完了状態の切り替え
  - タスク内容テキスト：クリックして編集モードに切り替え
  - 削除ボタン：タスクを削除
- 完了したタスクは取り消し線で表示される

**エラーハンドリング:**

- 認証されていないユーザーはリダイレクト処理により、`/` へ移動

#### 2. タスクの並び替え（ドラッグ&ドロップ）

**機能:**

各タスクアイテムの左側にあるドラッグハンドル（≡アイコン）をドラッグして、タスクの順序を変更できます。

**ユーザー操作:**

1. ドラッグハンドルをマウスで押下（ポインタ感度: 8px）
2. マウスを上下に移動してタスクの順序を変更
3. マウスボタンを放すと新しい順序が保存される

**キーボード操作:**

- `arrow-up/down` キーでもドラッグハンドルをフォーカス後に順序変更が可能（アクセシビリティ対応）

**処理フロー:**

```
1. ユーザーがドラッグハンドルをドラッグ開始
   ↓
2. ドラッグ中はタスクが半透明表示
   ↓
3. ドラッグ終了時にドラッグされたタスクと対象タスクを特定
   ↓
4. 浮動小数 order を使用して新しい order 値を計算
   ↓
5. `updateTasksOrder(taskListId, draggedTaskId, targetTaskId)` を呼び出し
   ↓
6. 必要に応じて reindex を実行
   ↓
7. トランザクションを使用して Firestore の `tasks[taskId].order` を更新
   ↓
8. ストアが更新され、自動的に画面に反映
```

**視覚的フィードバック:**

- ドラッグハンドルはホバー時に色が濃くなる（`hover:text-gray-600`）
- ドラッグ中のタスクは半透明表示（`opacity-50`）
- ドラッグハンドルは `cursor-grab` から `cursor-grabbing` に変更

**技術詳細:**

- ライブラリ: `@dnd-kit/core` と `@dnd-kit/sortable` を使用
- ポインタセンサーとキーボードセンサーの両方に対応
- 最も近い衝突検出アルゴリズムを使用（`closestCenter`）

#### 3. タスクの作成

**フォーム:**

- タスク入力フィールド：テキスト入力、履歴補完対応
- 追加ボタン：タスクを追加

**操作:**

1. 入力フィールドにタスク内容を入力
2. `Enter` キーを押すか「追加」ボタンをクリック
3. タスクがリストの最後に追加される

**履歴補完:**

- 入力フィールドは HTML の `datalist` を使用した補完機能を提供
- 過去に作成されたタスクテキストが候補として表示される
- リアルタイムでマッチしたテキストを候補リストから選択可能

**エラーハンドリング:**

- 空の入力は無効化（ボタンが disabled 状態）

#### 4. タスクの編集

**操作:**

1. タスク内容テキストをクリック
2. 編集モードに切り替わり、入力フィールドが表示される
3. テキストを編集
4. `Enter` キーで保存、`Escape` キーでキャンセル

#### 5. タスクの削除

**操作:**

1. タスクアイテムの削除ボタンをクリック
2. タスクが即座に削除される

#### 6. タスクの完了状態切り替え

**操作:**

1. チェックボックスをクリック
2. タスクの完了状態が切り替わる
3. 完了したタスクは取り消し線で表示される

#### 7. タスクリスト情報の編集

**リスト名の編集:**

1. リスト名をクリック
2. 編集モードに切り替わる
3. テキストを編集
4. `Enter` キーで保存、`Escape` キーでキャンセル

**リストの背景色変更:**

1. 「色を変更」ボタンをクリック
2. カラーピッカーモーダルが表示される
3. 色を選択して保存

#### 8. タスクリストの削除

**操作:**

1. 「リストを削除」ボタンをクリック
2. 確認モーダルが表示される
3. 削除を確認するとタスクリストとすべてのタスクが削除される

#### 9. タスクリストの共有

**機能:**

このタスクリストを他の人と共有できます。認証不要でshareCodeを使用して、誰でもタスクの閲覧・編集が可能です。

**操作:**

1. 「共有」ボタンをクリック
2. 共有モーダルが表示される
3. 「共有コードを生成」ボタンをクリックして共有コードを生成
4. 生成されたコードをコピーするか、共有URLをコピーして相手に送信
5. 共有を停止するには「共有を停止」ボタンをクリック

**共有コードの仕様:**

- 英数大文字のみで8文字
- ユニーク性を確保するためにFirestoreで検証
- 複数回生成することで異なるコードを取得可能
- 共有を停止するとコードは無効化される

### 状態管理

**ページレベルの状態:**

```typescript
const [state, setState] = useState<AppState | null>(null);
const [editingTaskId, setEditingTaskId] = useState<string | null>(null);
const [editingTaskText, setEditingTaskText] = useState("");
const [newTaskText, setNewTaskText] = useState("");
const [showEditListModal, setShowEditListModal] = useState(false);
const [editListName, setEditListName] = useState("");
const [editListColor, setEditListColor] = useState("");
const [editingListName, setEditingListName] = useState(false);
const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
```

### API インターフェース

#### addTask(taskListId: string, text: string, date?: string): Promise<string>

タスクを追加します。

**パラメータ:**

- `taskListId`: タスクリスト ID（必須）
- `text`: タスク内容（必須）
- `date`: タスクの日付（オプション）

**戻り値:**

- 作成されたタスク ID

**動作:**

1. 新しいタスク ID を生成
2. タスクの order を計算（insertPosition に基づいて先頭または末尾に配置）
3. 必要に応じて order を再インデックス
4. 新しいタスクオブジェクトを作成
5. トランザクション内で以下を実行：
   - Firestore にタスクを保存
   - history フィールドを更新（重複排除、最大300件保持）
6. `updatedAt` タイムスタンプを設定

**history 管理:**

- タスク作成時にテキストが既に history に存在しない場合のみ追加
- 新しいテキストは history の先頭に挿入（新しい順）
- history の件数が300を超えた場合、最古のテキストを削除
- 重複なし：同じテキストは複数回登録されない

#### updateTask(taskListId: string, taskId: string, updates: Partial<Task>): Promise<void>

タスクを更新します。

**パラメータ:**

- `taskListId`: タスクリスト ID
- `taskId`: タスク ID
- `updates`: 更新する内容（テキスト、完了状態など）

#### deleteTask(taskListId: string, taskId: string): Promise<void>

タスクを削除します。

**パラメータ:**

- `taskListId`: タスクリスト ID
- `taskId`: タスク ID

#### updateTasksOrder(taskListId: string, draggedTaskId: string, targetTaskId: string): Promise<void>

タスクの順序を更新します（ドラッグ&ドロップ時）。

**パラメータ:**

- `taskListId`: タスクリスト ID
- `draggedTaskId`: ドラッグされたタスク ID
- `targetTaskId`: ドロップ先のタスク ID（この前に挿入）

**例:**

```typescript
await updateTasksOrder(taskListId, "task-1", "task-3");
// task-1 が task-3 の前に移動
```

**動作:**

1. 浮動小数 order を使用して新しい order 値を計算
   - ドラッグされたタスクと対象タスクの order の中間値（例: (1.0 + 2.0) / 2 = 1.5）
   - 先頭または末尾への移動に対応
   - 複数の order 更新が不要な設計（ドラッグされたタスク1件のみ更新）
2. 小数が枯渇している場合は自動的に reindex を実行
3. ローカルストアを楽観的に更新
4. トランザクションを使用して Firestore の `tasks[draggedTaskId].order` を更新
5. `updatedAt` タイムスタンプを自動設定
6. ストアの変更をリスナーに通知

**技術仕様：**

- **order フィールド:** 浮動小数（整数ではなく 1.5, 2.25 など）
- **更新件数:** 基本的にドラッグされたタスク1件のみ（reindex 時は全タスク）
- **reindex 判定:** MIN_ORDER_GAP (0.0001) より小さい order 間隔の場合に自動実行
- **トランザクション処理:** 並行更新時の安全性を確保
- **優位性:** 整数 order に比べて、並び替え時の競合が大幅に減少

### 翻訳キー

タスク詳細ページの UI テキストは i18next を使用して多言語対応されています。

**メッセージキー:**

```
taskList:
  taskCount: タスク数表示
  editColor: 色変更ボタンのテキスト
  addTask: 追加ボタンのテキスト
  addTaskPlaceholder: タスク入力フィールドのプレースホルダー
  selectColor: カラーピッカーのタイトル
  deleteList: リスト削除ボタンのテキスト
  deleteConfirm: 削除確認メッセージ
  dragHint: ドラッグハンドルのツールチップ
```

詳細は `locales/ja.json` および `locales/en.json` を参照してください。

### デザイン仕様

#### タスクアイテム

- **背景:** 白色（`bg-white`）
- **シャドウ:** 標準シャドウ（`shadow`）
- **コーナー:** 丸角（`rounded-lg`）
- **内部構造:**
  - ドラッグハンドル、チェックボックス、テキスト、削除ボタンが左から右へ配置
  - ドラッグハンドルは `cursor-grab`、ドラッグ中は `cursor-grabbing`
- **ホバー効果:**
  - シャドウ増加（`shadow-md`）
  - スムーズなトランジション（`transition-shadow`）
- **ドラッグ中:**
  - 半透明表示（`opacity-50`）

#### ドラッグハンドル

- **アイコン:** ≡ アイコン（6ドット）
- **色:** グレー（`text-gray-400`）
- **ホバー色:** より濃いグレー（`hover:text-gray-600`）
- **カーソル:** `cursor-grab` / `cursor-grabbing`

#### チェックボックス

- **スタイル:** 標準 HTML チェックボックス
- **サイズ:** `w-5 h-5`
- **色:** インディゴ（フォーカス時）

#### タスクテキスト

- **完了時:** 取り消し線（`line-through`）、グレー色（`text-gray-400`）
- **未完了:** 通常の色（`text-gray-800`）
- **ホバー:** 薄いグレー背景（`hover:bg-gray-100`）

#### 削除ボタン

- **背景:** 薄い赤（`bg-red-50`）
- **テキスト色:** 赤（`text-red-600`）
- **ホバー:** より濃い背景（`hover:bg-red-100`）

## 翻訳キー（タスクリスト一覧ページ）

タスクリスト一覧ページの UI テキストは i18next を使用して多言語対応されています。

**メッセージキー:**

```
app:
  dragHint: ドラッグハンドルのツールチップ
```

詳細は `locales/ja.json` および `locales/en.json` を参照してください。

## 共有ページ

**ページ:** `src/pages/sharecodes/[sharecode].tsx`

### 概要

shareCodeを使用して、認証なしでタスクリストを閲覧・編集できるページです。オーナーと同じUIでタスクの操作が可能であり、自分のリストに追加することもできます。

### 主要機能

#### 1. 共有リストの表示

**仕様:**

- URLのshareCodeパラメータから自動的にタスクリストを読み込む
- タスクの一覧をリスト形式で表示
- タスクリストの背景色を反映

**エラーハンドリング:**

- shareCodeが無効な場合はエラーメッセージを表示
- 読み込み中はローディング表示を表示

#### 2. タスク操作

**可能な操作:**

- タスク追加：新規タスク入力と「追加」ボタン
- タスク編集：テキストをクリックして編集モード
- タスク削除：削除ボタンをクリック
- 完了状態切り替え：チェックボックスをクリック
- タスク並び替え：ドラッグ&ドロップ

認証不要であり、誰でもこのリスト上のタスクを操作できます。

#### 3. 自分のリストに追加

**仕様:**

- ページ右上に「自分のリストに追加」ボタンを表示（ログイン済みユーザーのみ）
- クリックするとこのタスクリストが自分の`taskListOrder`に追加される
- 追加後、`/app`ページへリダイレクト

**エラーハンドリング:**

- 既に自分のリストに存在する場合はエラーメッセージを表示
- ログインしていない場合はボタンを表示しない

### 状態管理

**ページレベルの状態:**

```typescript
const [taskList, setTaskList] = useState<TaskListStore | null>(null);
const [loading, setLoading] = useState(true);
const [error, setError] = useState<string | null>(null);
const [user, setUser] = useState<typeof auth.currentUser>(null);
const [editingTaskId, setEditingTaskId] = useState<string | null>(null);
// ... その他のタスク編集状態
```

### API インターフェース

#### fetchTaskListByShareCode(shareCode: string): Promise<TaskListStore | null>

指定されたshareCodeでタスクリストを取得します。

**パラメータ:**

- `shareCode`: 共有コード（必須）

**戻り値:**

- TaskListStore オブジェクト、または見つからない場合は null

**動作:**

1. Firestore の taskLists コレクションで shareCode フィールドを検索
2. 一致するタスクリストを返す
3. 複数一致する場合は最初のドキュメントを返す

#### addSharedTaskListToOrder(taskListId: string): Promise<void>

ログイン中のユーザーが共有されたタスクリストを自分のorderに追加します。

**パラメータ:**

- `taskListId`: タスクリスト ID（必須）

**動作:**

1. 現在のユーザーがログインしているか確認
2. 既に追加されているか確認
3. 新しい order 値を計算（最大order + 1.0）
4. `taskListOrder/{uid}` ドキュメントに追加
5. `/app` ページへリダイレクト

### 翻訳キー

共有ページの UI テキストは i18next を使用して多言語対応されています。

**メッセージキー:**

```
pages:
  sharecode:
    notFound: このタスクリストが見つかりません
    error: タスクリストを読み込めませんでした
    addTaskError: タスクを追加できませんでした
    updateError: タスクを更新できませんでした
    deleteError: タスクを削除できませんでした
    reorderError: タスクの順序を変更できませんでした
    addToOrderError: このタスクリストを追加できませんでした
    addToOrder: 自分のリストに追加
```

詳細は `locales/ja.json` および `locales/en.json` を参照してください。

### セキュリティ考慮事項

**現在の仕様:**

- 認証なしでタスクの閲覧・編集が可能
- shareCodeの推測は困難（8文字のランダム英数大文字）
- ただし、shareCodeが漏洩すると誰でもアクセス可能

**将来の改善:**

- Firestore セキュリティルールで shareCode の検証
- 一定時間でコードの自動失効機能
- アクセスログの記録機能

## 今後の拡張機能

- カスタム背景色選択の拡張
- タスクのカテゴリ分類機能
- 優先度の設定機能
- タスクのフィルタリング・検索機能
- 共有コード有効期限設定機能
- 読み取り専用共有モード
